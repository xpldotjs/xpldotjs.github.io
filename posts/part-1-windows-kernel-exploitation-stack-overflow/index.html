<!doctype html>
<html lang="en-us">
  <head>
    <title>Part 1 Windows Kernel Exploitation Stack Overflow // Xploiter</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.87.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Sherchan" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://xpldotjs.github.io/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Part 1 Windows Kernel Exploitation Stack Overflow"/>
<meta name="twitter:description" content="Intro This is my first time looking into Kernel Exploitation so i decided to practice on HEVD Driver by @hacksys. I&rsquo;ve written this blog post to better understand the kernel space and upgrade my skills. Since this is my first time doing kernel exploitation, i&rsquo;ll be going with the stack overflow. Our setup is:
 Windows 10 x64 bit HEVD 3.0 Windbg Preview IDA  Looking into source code Because i&rsquo;m rookie on kernel exploitation, i want to look at the source code before reversing the driver."/>

    <meta property="og:title" content="Part 1 Windows Kernel Exploitation Stack Overflow" />
<meta property="og:description" content="Intro This is my first time looking into Kernel Exploitation so i decided to practice on HEVD Driver by @hacksys. I&rsquo;ve written this blog post to better understand the kernel space and upgrade my skills. Since this is my first time doing kernel exploitation, i&rsquo;ll be going with the stack overflow. Our setup is:
 Windows 10 x64 bit HEVD 3.0 Windbg Preview IDA  Looking into source code Because i&rsquo;m rookie on kernel exploitation, i want to look at the source code before reversing the driver." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xpldotjs.github.io/posts/part-1-windows-kernel-exploitation-stack-overflow/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-21T18:25:48+05:45" />
<meta property="article:modified_time" content="2021-03-21T18:25:48+05:45" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://xpldotjs.github.io"><img class="app-header-avatar" src="/avatar.jpg" alt="John Sherchan" /></a>
      <h1>Xploiter</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>In love with Browser Exploitation</p>
      <div class="app-header-social">
        
          <a href="https://github.com/xpldotjs" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://www.facebook.com/john.sherchan.9/" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-facebook">
  <title>My Facebook</title>
  <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Part 1 Windows Kernel Exploitation Stack Overflow</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Mar 21, 2021
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <h3 id="intro">Intro</h3>
<p>This is my first time looking into Kernel Exploitation so i decided to practice on HEVD Driver by @hacksys. I&rsquo;ve written this blog post to better understand the kernel space and upgrade my skills. Since this is my first time doing kernel exploitation, i&rsquo;ll be going with the stack overflow. Our setup is:</p>
<ol>
<li>Windows 10 x64 bit</li>
<li>HEVD 3.0</li>
<li>Windbg Preview</li>
<li>IDA</li>
</ol>
<h4 id="looking-into-source-code">Looking into source code</h4>
<p>Because i&rsquo;m rookie on kernel exploitation, i want to look at the source code before reversing the driver.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">NTSTATUS <span style="color:#a6e22e">BufferOverflowStackIoctlHandler</span>(
    _In_ PIRP Irp,
    _In_ PIO_STACK_LOCATION IrpSp
)
{
    SIZE_T Size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    PVOID UserBuffer <span style="color:#f92672">=</span> NULL;
    NTSTATUS Status <span style="color:#f92672">=</span> STATUS_UNSUCCESSFUL;

    UNREFERENCED_PARAMETER(Irp);
    PAGED_CODE();

    UserBuffer <span style="color:#f92672">=</span> IrpSp<span style="color:#f92672">-&gt;</span>Parameters.DeviceIoControl.Type3InputBuffer;
    Size <span style="color:#f92672">=</span> IrpSp<span style="color:#f92672">-&gt;</span>Parameters.DeviceIoControl.InputBufferLength;

    <span style="color:#66d9ef">if</span> (UserBuffer)
    {
        <span style="color:#75715e">// If we manipulate the size of user buffer we&#39;ll trigger stackoverflow
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>        Status <span style="color:#f92672">=</span> TriggerBufferOverflowStack(UserBuffer, Size); 
</span>    }

    <span style="color:#66d9ef">return</span> Status;
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">NTSTATUS
<span style="color:#a6e22e">TriggerBufferOverflowStack</span>(
    _In_ PVOID UserBuffer,
    _In_ SIZE_T Size
)
{
    NTSTATUS Status <span style="color:#f92672">=</span> STATUS_SUCCESS;
    ULONG KernelBuffer[BUFFER_SIZE] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> }; 
    <span style="color:#75715e">// ... other codes
</span><span style="color:#75715e"></span>
    DbgPrint(<span style="color:#e6db74">&#34;[+] Triggering Buffer Overflow in Stack</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#75715e">// This function will copy the UserBuffer into the KernelBuffer without
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// validating the size i.e., if the UserBuffer size is greater than 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// size of the KernelBuffer and this will cause the overflow 
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#75715e"></span>    RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, Size); 
</span>}
</code></pre></div><p>From the Above code we can see that if the <code>UserBuffer</code> is not null then it&rsquo;ll call the function <code>TriggerBufferOverflowStack(UserBuffer,Size)</code>. Inside this function there&rsquo;s a insecure version of code, in there <code>RtlCopyMemory</code> function copies the UserBuffer into the KernelBuffer without proper size check. This will help us on exploiting this vulnerability.</p>
<h4 id="disassembling-the-driver">Disassembling the driver</h4>
<p>There is the IrpDeviceIoCtlHandler() function which contains the jump table for each IOCTL code.</p>
<p><img src="/posts/static/KernelExpPartOne/001-IrpDeviceIoCtlHandler-switch-table.png" alt="IrpDeviceIoCtlHandler"></p>
<p>Inside the DriverEntry function we can see that <code>IoCreateDevice()</code> is being called. Drivers and user-mode components access most system-defined objects through handles. To obtain a handle to a driver object, a driver needs to expose at least one device object which is done through IoCreateDevice.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">//The IoCreateDevice routine creates a device object for use by a driver
</span><span style="color:#75715e">//and saves a pointer to it in the DeviceObject variable
</span><span style="color:#75715e"></span>NTSTATUS <span style="color:#a6e22e">IoCreateDevice</span>(
  PDRIVER_OBJECT  DriverObject,             <span style="color:#75715e">//DriverObject
</span><span style="color:#75715e"></span>  ULONG           DeviceExtensionSize,      <span style="color:#75715e">//DeviceExtensionSize
</span><span style="color:#75715e"></span>  PUNICODE_STRING DeviceName,               <span style="color:#75715e">//DeviceName
</span><span style="color:#75715e"></span>  DEVICE_TYPE     DeviceType,               <span style="color:#75715e">//DeviceType
</span><span style="color:#75715e"></span>  ULONG           DeviceCharacteristics,    <span style="color:#75715e">//DeviceCharacteristics
</span><span style="color:#75715e"></span>  BOOLEAN         Exclusive,                <span style="color:#75715e">//Exclusive
</span><span style="color:#75715e"></span>  PDEVICE_OBJECT  <span style="color:#f92672">*</span>DeviceObject             <span style="color:#75715e">//DeviceObject
</span><span style="color:#75715e"></span>);
</code></pre></div><p>Inside the DriverEntry we can see the DeviceName as <code>\\Device\\HackSysExtremeVulnerableDriver</code>.</p>
<p><img src="/posts/static/KernelExpPartOne/002-IoCreateDevice.png" alt="DeviceString"></p>
<p>Let&rsquo;s find <code>BufferOverflowStackIoctlHandler</code> inside <code>IrpDeviceIoCtlHandler</code> call. As we can see if the IOCTL is <code>0x222003h</code>, it&rsquo;ll jumps to the code block where <code>BufferOverflowStackIoctlHandler</code> function is present.</p>
<p><img src="/posts/static/KernelExpPartOne/003-switch-table-ioctl.png" alt="SwitchTable"></p>
<p>From the <code>BufferOverflowStackIoctlHandler</code> function <code>TriggerBufferOverflowStack</code> function will be called if the UserBuffer is not empty.</p>
<p><img src="/posts/static/KernelExpPartOne/005-triggerbufferoverflow.png" alt="TriggerBufferOverflowStack"></p>
<p>If we open up the <code>TriggerBufferOverflowStack</code> function in IDA we can see the buffersize that <code>KernelBuffer</code> accepts which is <code>2048</code>.</p>
<p><img src="/posts/static/KernelExpPartOne/004-size-of-kernel-buffer.png" alt="SizeOfKernelBuffer"></p>
<p>Now we know that the KernelBuffer accepts the buffer size of <code>2048</code>, and there is no buffer size checks while copying UserBuffer into KernelBuffer. So, to trigger the bug we need to send buffer with size <code>greater than 2048</code>.</p>
<h4 id="talking-to-driver">Talking to driver</h4>
<p>Since this is the kernel exploitation, we need a way to talk to the kernel driver because we cannot directly touch the kernel mode objects and device driver directly from the user mode. To communicate from the userland, We need to have a handle to that particular device. We can simply create a handle to the driver object using <code>CreateFileA</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">HANDLE <span style="color:#a6e22e">CreateFileA</span>(
  LPCSTR                lpFileName,
  DWORD                 dwDesiredAccess,
  DWORD                 dwShareMode,
  LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  DWORD                 dwCreationDisposition,
  DWORD                 dwFlagsAndAttributes,
  HANDLE                hTemplateFile
);
</code></pre></div><p>Then we can interact with the driver by sending IOCTL codes using <code>DeviceIoControl()</code> Function. Each calls to the <code>DeviceIoControl()</code> function causes I/O manager to create an I/O Request Packet (IRP) whose major function is IRP_MJ_DEVICE_CONTROL and sends it to the corresponding dispatch routine of the device driver.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">BOOL <span style="color:#a6e22e">DeviceIoControl</span>(
  HANDLE       hDevice,
  DWORD        dwIoControlCode,
  LPVOID       lpInBuffer,
  DWORD        nInBufferSize,
  LPVOID       lpOutBuffer,
  DWORD        nOutBufferSize,
  LPDWORD      lpBytesReturned,
  LPOVERLAPPED lpOverlapped
);
</code></pre></div><h2 id="writing-exploit">Writing Exploit</h2>
<p>Till now we know three important things to begin with, DeviceName (<code>\\Device\\HackSysExtremeVulnerableDriver</code>), the length that the buffer accepts (<code>0x800 or 2048</code>), and the IOCTL code (<code>0x222003h</code>).</p>
<h4 id="triggering-the-crash">Triggering the crash</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">
</code></pre></div><h3 id="references">References</h3>
<p><a href="https://h0mbre.github.io/HEVD_Stackoverflow_64bit/#">https://h0mbre.github.io/HEVD_Stackoverflow_64bit/#</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
